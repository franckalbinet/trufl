<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Optimizing adaptive sampling using Multiple-Criteria Decision-Making">

<title>Trufl – trufl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Trufl – trufl">
<meta property="og:description" content="Optimizing adaptive sampling using Multiple-Criteria Decision-Making">
<meta property="og:site_name" content="trufl">
<meta name="twitter:title" content="Trufl – trufl">
<meta name="twitter:description" content="Optimizing adaptive sampling using Multiple-Criteria Decision-Making">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">trufl</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./index.html">Trufl</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Trufl</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Source code</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reader.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reader</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sampler.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimizer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mcdm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MCDM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Collector</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#install" id="toc-install" class="nav-link active" data-scroll-target="#install">Install</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a>
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#our-simulated-ground-truth" id="toc-our-simulated-ground-truth" class="nav-link" data-scroll-target="#our-simulated-ground-truth">Our simulated ground truth</a></li>
  <li><a href="#simulate-administrative-units" id="toc-simulate-administrative-units" class="nav-link" data-scroll-target="#simulate-administrative-units">Simulate administrative units</a></li>
  <li><a href="#round-i-optimize-sampling-based-on-prior-at-t_0" id="toc-round-i-optimize-sampling-based-on-prior-at-t_0" class="nav-link" data-scroll-target="#round-i-optimize-sampling-based-on-prior-at-t_0">Round I: Optimize sampling based on prior at <span class="math inline">\(t_0\)</span></a>
  <ul class="collapse">
  <li><a href="#what-prior-knowledge-do-we-have" id="toc-what-prior-knowledge-do-we-have" class="nav-link" data-scroll-target="#what-prior-knowledge-do-we-have">What prior knowledge do we have?</a></li>
  <li><a href="#sampling-priority-ranks" id="toc-sampling-priority-ranks" class="nav-link" data-scroll-target="#sampling-priority-ranks">Sampling priority ranks</a></li>
  <li><a href="#informed-random-sampling" id="toc-informed-random-sampling" class="nav-link" data-scroll-target="#informed-random-sampling">Informed random sampling</a></li>
  <li><a href="#emulating-measurement-campaign" id="toc-emulating-measurement-campaign" class="nav-link" data-scroll-target="#emulating-measurement-campaign">Emulating measurement campaign</a></li>
  </ul></li>
  <li><a href="#round-ii-optimize-sampling-with-additional-insights-at-t_1" id="toc-round-ii-optimize-sampling-with-additional-insights-at-t_1" class="nav-link" data-scroll-target="#round-ii-optimize-sampling-with-additional-insights-at-t_1">Round II: Optimize sampling with additional insights at <span class="math inline">\(t_1\)</span></a>
  <ul class="collapse">
  <li><a href="#getting-administrative-units-new-state" id="toc-getting-administrative-units-new-state" class="nav-link" data-scroll-target="#getting-administrative-units-new-state">Getting administrative units new state</a></li>
  <li><a href="#finding-optimal-number-of-samples-to-be-collected" id="toc-finding-optimal-number-of-samples-to-be-collected" class="nav-link" data-scroll-target="#finding-optimal-number-of-samples-to-be-collected">Finding optimal number of samples to be collected</a></li>
  <li><a href="#informed-random-sampling-1" id="toc-informed-random-sampling-1" class="nav-link" data-scroll-target="#informed-random-sampling-1">Informed random sampling</a></li>
  <li><a href="#second-measurement-campaign" id="toc-second-measurement-campaign" class="nav-link" data-scroll-target="#second-measurement-campaign">Second measurement campaign</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#delving-deeper-into-the-optimization-process" id="toc-delving-deeper-into-the-optimization-process" class="nav-link" data-scroll-target="#delving-deeper-into-the-optimization-process">Delving deeper into the optimization process</a>
  <ul>
  <li><a href="#determine-the-ranking-of-the-administrative-polygons" id="toc-determine-the-ranking-of-the-administrative-polygons" class="nav-link" data-scroll-target="#determine-the-ranking-of-the-administrative-polygons">Determine the ranking of the administrative polygons</a>
  <ul class="collapse">
  <li><a href="#criteria" id="toc-criteria" class="nav-link" data-scroll-target="#criteria">Criteria</a></li>
  <li><a href="#criteria-type" id="toc-criteria-type" class="nav-link" data-scroll-target="#criteria-type">Criteria type</a></li>
  <li><a href="#weights" id="toc-weights" class="nav-link" data-scroll-target="#weights">Weights</a></li>
  <li><a href="#mcdm-techniques" id="toc-mcdm-techniques" class="nav-link" data-scroll-target="#mcdm-techniques">MCDM techniques</a></li>
  <li><a href="#rank" id="toc-rank" class="nav-link" data-scroll-target="#rank">Rank</a></li>
  </ul></li>
  <li><a href="#multi-year-adaptive-sampling-approach" id="toc-multi-year-adaptive-sampling-approach" class="nav-link" data-scroll-target="#multi-year-adaptive-sampling-approach">Multi-year Adaptive sampling approach</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/franckalbinet/trufl/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Trufl</h1>
</div>

<div>
  <div class="description">
    Optimizing adaptive sampling using Multiple-Criteria Decision-Making
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p><strong>Trufl</strong> was initiated in the context of the <a href="https://www.iaea.org">IAEA (International Atomic Energy Agency)</a> Coordinated Research Project (CRP) titled <a href="https://www.iaea.org/newscenter/news/new-crp-monitoring-and-predicting-radionuclide-uptake-and-dynamics-for-optimizing-remediation-of-radioactive-contamination-in-agriculture-crp-d15019">“Monitoring and Predicting Radionuclide Uptake and Dynamics for Optimizing Remediation of Radioactive Contamination in Agriculture”</a>.</p>
<p>While <strong>Trufl</strong> was originally developed to address the remediation of farmland affected by nuclear accidents, its approach and algorithms are <strong>applicable to a wide range of application domains</strong>. This includes managing <strong>legacy contaminants</strong> or monitoring phenomena that require consideration of multiple decision criteria over time, taking into account a wide range of factors and contexts.</p>
<p>This package leverages the work done by <a href="https://www.linkedin.com/in/floris-abrams-59080a15a">Floris Abrams</a> in the context of his PhD in collaboration between <a href="https://www.sckcen.be">SCK CEN</a> and <a href="https://www.kuleuven.be">KU Leuven</a> and <a href="https://www.linkedin.com/in/franckalbinet">Franck Albinet</a>, International Consultant in Geospatial Data Science and currently PhD researcher in AI applied to nuclear remedation at <a href="https://www.kuleuven.be">KU Leuven</a>.</p>
<section id="install" class="level2">
<h2 class="anchored" data-anchor-id="install">Install</h2>
<p><code>pip install trufl</code></p>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<p>In highly sensitive and high-stakes situations, it is <strong>essential that decision making is informed, transparent, and accountable</strong>, with decisions being based on a thorough and objective analysis of the available data and the needs and concerns of affected communities being taken into account.</p>
<p>Given the time constraints and limited budgets that are often associated with data surveys (in particular ones supposed to informed highly sensitive situation), it is <strong>crucial to make informed decisions about how to allocate resources</strong>. This is even more important when considering the many variables that can be taken into account, such as prior knowledge of the area, health and economic impacts, land use, whether remediation has already taken place, population density, and more. Our approach leverages <strong>Multiple-criteria decision-making</strong> approaches to optimize the data survey workflow:</p>
<p>In this demo, we will walk you through a <strong>typical workflow</strong> using the <code>Trufl</code> package. To help illustrate the process, we will use a “toy” dataset that represents a typical spatial pattern of soil contaminants.</p>
<ol type="1">
<li>We <strong>assume that we have access to the ground truth</strong>, which is a raster file that shows the spatial distribution of a soil contaminant;</li>
<li>We will make decisions about how to optimally sample the <strong>administrative units (polygons)</strong>, which in this case are <strong>simulated as a grid</strong> (using the <a href="https://franckalbinet.github.io/trufl/utils.html#gridder"><code>gridder</code></a> utilities function);</li>
<li>Based on prior knowledge, such as prior airborne surveys or other data, an <a href="https://franckalbinet.github.io/trufl/optimizer.html#optimizer"><code>Optimizer</code></a> will <strong>rank each administrative unit (grid cell) according to its priority for sampling</strong>;</li>
<li>We will then <strong>perform random sampling on the designated units (grid cells)</strong> (using a <a href="https://franckalbinet.github.io/trufl/sampler.html#sampler"><code>Sampler</code></a>). To simulate the measurement process, we will use the ground truth to emulate measurements at each location (using a <a href="https://franckalbinet.github.io/trufl/collector.html#datacollector"><code>DataCollector</code></a>);</li>
<li>We will <strong>evaluate the new state of each unit based on the measurements</strong> and <strong>pass it to a new round of optimization</strong>. This process will be repeated iteratively to refine the sampling strategy.</li>
</ol>
<section id="imports" class="level3">
<h3 class="anchored" data-anchor-id="imports">Imports</h3>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.lines <span class="im">as</span> mlines</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trufl.utils <span class="im">import</span> gridder</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trufl.sampler <span class="im">import</span> Sampler, rank_to_sample</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trufl.collector <span class="im">import</span> DataCollector</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trufl.callbacks <span class="im">import</span> (State, MaxCB, MinCB, StdCB, CountCB, MoranICB, PriorCB)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trufl.optimizer <span class="im">import</span> Optimizer</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>red, black <span class="op">=</span> <span class="st">'#BF360C'</span>, <span class="st">'#263238'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="our-simulated-ground-truth" class="level3">
<h3 class="anchored" data-anchor-id="our-simulated-ground-truth">Our simulated ground truth</h3>
<p>The assumed ground truth reveals a typical spatial pattern of contaminant such as <code>Cs137</code> after a nuclear accident for instance:</p>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fname_raster <span class="op">=</span> <span class="st">'./files/ground-truth-01-4326-simulated.tif'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(fname_raster) <span class="im">as</span> src:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    plt.imshow(src.read(<span class="dv">1</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Simulated Ground Truth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="simulate-administrative-units" class="level3">
<h3 class="anchored" data-anchor-id="simulate-administrative-units">Simulate administrative units</h3>
<p>The sampling strategy will be determined on a per-grid-cell basis within the administrative unit. We define below a 10 x 10 grid over the area of interest:</p>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>gdf_grid <span class="op">=</span> gridder(fname_raster, nrows<span class="op">=</span><span class="dv">10</span>, ncols<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>gdf_grid.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loc_id</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POLYGON ((-1.20830 43.26950, -1.20830 43.26042...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POLYGON ((-1.20830 43.27858, -1.20830 43.26950...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POLYGON ((-1.20830 43.28766, -1.20830 43.27858...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>POLYGON ((-1.20830 43.29673, -1.20830 43.28766...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>POLYGON ((-1.20830 43.30581, -1.20830 43.29673...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note how each administrative unit is uniquely identified by its <code>loc_id</code>.</p>
</div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gdf_grid.boundary.plot(color<span class="op">=</span>black, lw<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Simulated Administrative Units'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="round-i-optimize-sampling-based-on-prior-at-t_0" class="level3">
<h3 class="anchored" data-anchor-id="round-i-optimize-sampling-based-on-prior-at-t_0">Round I: Optimize sampling based on prior at <span class="math inline">\(t_0\)</span></h3>
<section id="what-prior-knowledge-do-we-have" class="level4">
<h4 class="anchored" data-anchor-id="what-prior-knowledge-do-we-have">What prior knowledge do we have?</h4>
<p>At the initial time <span class="math inline">\(t_0\)</span>, data sampling has not yet begun, but we can often <strong>leverage existing prior knowledge of our phenomenon</strong> of interest to inform our sampling strategy/policy. In the context of nuclear remediation, this prior knowledge can often be obtained through mobile surveys, such as airborne or carborne surveys, which can provide a <strong>coarse estimation</strong> of soil contamination levels.</p>
<p>In the example below, we <strong>simulate prior information</strong> about the soil property of interest by <strong>calculating the average value of the property over each grid cell</strong>.</p>
<p>At this stage, we have no measurements, so we simply create an empty <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.html">Geopandas GeoDataFrame</a>.</p>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>samples_t0 <span class="op">=</span> gpd.GeoDataFrame(index<span class="op">=</span>pd.Index([], name<span class="op">=</span><span class="st">'loc_id'</span>), </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                              geometry<span class="op">=</span><span class="va">None</span>, data<span class="op">=</span>{<span class="st">'value'</span>: <span class="va">None</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We need to set an index <code>loc_id</code> and have a <code>geometry</code> and <code>value</code> columns.</p>
</div>
</div>
<p>Now we get/“sense” the state of our grid cells based on the simulated prior (Mean over each grid cell <a href="https://franckalbinet.github.io/trufl/callbacks.html#priorcb"><code>PriorCB</code></a>):</p>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> State(samples_t0, gdf_grid, cbs<span class="op">=</span>[PriorCB(fname_raster)])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># You have to call the instance</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>state_t0 <span class="op">=</span> state()<span class="op">;</span> state_t0.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Prior</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loc_id</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.102492</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.125727</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.161802</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.184432</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.201405</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>gdf_grid.join(state_t0, how<span class="op">=</span><span class="st">'left'</span>).plot(column<span class="op">=</span><span class="st">'Prior'</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                                         cmap<span class="op">=</span><span class="st">'viridis'</span>, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                         legend_kwds<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Value'</span>}, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                         legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Prior: Mean value at Administrative Unit level'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We get the <code>Prior</code> for each individual <code>loc_id</code> (here only the first 5 shown). The current <a href="https://franckalbinet.github.io/trufl/callbacks.html#state"><code>State</code></a> is only composed of a single <a href="https://franckalbinet.github.io/trufl/callbacks.html#priorcb"><code>PriorCB</code></a> variable but can include many more variables as we will see below.</p>
</div>
</div>
</section>
<section id="sampling-priority-ranks" class="level4">
<h4 class="anchored" data-anchor-id="sampling-priority-ranks">Sampling priority ranks</h4>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>benefit_criteria <span class="op">=</span> [<span class="va">True</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> Optimizer(state<span class="op">=</span>state_t0)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_rank <span class="op">=</span> optimizer.get_rank(is_benefit_x<span class="op">=</span>benefit_criteria, w_vector <span class="op">=</span> [<span class="dv">1</span>],  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                             n_method<span class="op">=</span><span class="va">None</span>, c_method <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                             w_method<span class="op">=</span><span class="va">None</span>, s_method<span class="op">=</span><span class="st">"CP"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>df_rank.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loc_id</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">91</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">94</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">82</td>
<td>5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more information on how the <a href="https://franckalbinet.github.io/trufl/optimizer.html#optimizer"><code>Optimizer</code></a> operates, please see the section <a href="#delving-deeper-into-the-optimization-process">Delving deeper into the optimization process</a>.</p>
</div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gdf_grid.join(df_rank, how<span class="op">=</span><span class="st">'left'</span>).plot(column<span class="op">=</span><span class="st">'rank'</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                                        cmap<span class="op">=</span><span class="st">'viridis_r'</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                                        legend_kwds<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Rank'</span>}, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                                        legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Sampling Priorirty Rank'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="informed-random-sampling" class="level4">
<h4 class="anchored" data-anchor-id="informed-random-sampling">Informed random sampling</h4>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s worth noting that in the absence of any prior knowledge, a uniform sampling strategy over the area of interest may be used. However, this approach may not be the most efficient use of the available data collection and analysis budget.</p>
</div>
</div>
<p>Based on the <strong>ranks (sampling priority)</strong> calculated by the <a href="https://franckalbinet.github.io/trufl/optimizer.html#optimizer"><code>Optimizer</code></a> and given sampling <strong>budget</strong>, let’s calculate the number of samples to be collected for each administrative unit (<code>loc_id</code>). <strong>Different sampling policies</strong> can be used (Weighted, Quantiles, …):</p>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>budget_t0 <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> rank_to_sample(df_rank[<span class="st">'rank'</span>].sort_index().values, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                   budget<span class="op">=</span>budget_t0, <span class="bu">min</span><span class="op">=</span><span class="dv">1</span>, policy<span class="op">=</span><span class="st">"quantiles"</span>)<span class="op">;</span> n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([ 1,  1,  1,  1,  1,  1,  1,  1,  1,  4,  1,  1,  1,  1,  1,  4,  4,
        4,  4,  4,  1,  1,  1,  1,  1,  4,  4,  4,  4,  4,  1,  1,  1,  4,
        4,  7,  7, 12,  7,  7,  1,  1,  4,  4,  7, 12, 12, 12, 12,  7,  1,
        4,  4,  7,  7, 12, 12, 12,  7,  4,  4,  4,  7,  7,  7,  7,  7,  7,
        4,  4,  4,  7, 12,  7, 12, 12,  7,  7,  4,  4,  7, 12, 12, 12, 12,
       12, 12, 12,  7,  7, 12, 12, 12, 12, 12, 12, 12,  7,  7,  7])</code></pre>
</div>
</div>
<p>We can now decide where to sample based on this sampling schema:</p>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> Sampler(gdf_grid)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sample_locs_t0 <span class="op">=</span> sampler.sample(n, method<span class="op">=</span><span class="st">'uniform'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sample_locs_t0.head())</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sample_locs_t0.plot(markersize<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span>red)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>gdf_grid.boundary.plot(color<span class="op">=</span>black, lw<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Ranked Random Samples Location'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                         geometry
loc_id                           
0       POINT (-1.21727 43.26778)
1       POINT (-1.22102 43.27806)
2       POINT (-1.21712 43.27979)
3       POINT (-1.22145 43.29287)
4       POINT (-1.21036 43.30109)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="emulating-measurement-campaign" class="level4">
<h4 class="anchored" data-anchor-id="emulating-measurement-campaign">Emulating measurement campaign</h4>
<p>The data collector collects measurements at the random sampling locations in the field. In our case, we emulate this process by extracting measurements from the provided raster file.</p>
<p>“Measuring” variable of interest from a given raster:</p>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dc_emulator <span class="op">=</span> DataCollector(fname_raster)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>measurements_t0 <span class="op">=</span> dc_emulator.collect(sample_locs_t0)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(measurements_t0.head())</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> measurements_t0.plot(column<span class="op">=</span><span class="st">'value'</span>, s<span class="op">=</span><span class="dv">2</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>gdf_grid.boundary.plot(color<span class="op">=</span>black, lw<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Measurements at Random Sampling Points'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                         geometry     value
loc_id                                     
0       POINT (-1.21727 43.26778)  0.137188
1       POINT (-1.22102 43.27806)  0.151005
2       POINT (-1.21712 43.27979)  0.164272
3       POINT (-1.22145 43.29287)  0.181001
4       POINT (-1.21036 43.30109)  0.168969</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This marks the <strong>end of our initial measurement efforts</strong>, based on our prior knowledge of the phenomenon. <strong>Going forward, we can use the additional insights gained during this phase</strong> to enhance our future measurements.</p>
</section>
</section>
<section id="round-ii-optimize-sampling-with-additional-insights-at-t_1" class="level3">
<h3 class="anchored" data-anchor-id="round-ii-optimize-sampling-with-additional-insights-at-t_1">Round II: Optimize sampling with additional insights at <span class="math inline">\(t_1\)</span></h3>
<p>For each administrative unit, we now have additional knowledge acquired during the previous campaign, in addition to our prior knowledge. <strong>In the current round</strong>, the <strong>optimization</strong> of the sampling will be <strong>carried out based on</strong> the <strong>maximum</strong>, <strong>minimum</strong>, <strong>standard Deviation</strong>, <strong>number of measurements</strong> already conducted, our <strong>prior knowledge</strong>, and an estimate of the <strong>presence of spatial trends</strong> or spatial correlations (Moran’s I).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s worth noting that you can use any quantitative or qualitative secondary geographical information as a variable in the state, such as population, whether any previous remediation actions have taken place, the economic impact of the contamination, and so on.</p>
</div>
</div>
<section id="getting-administrative-units-new-state" class="level4">
<h4 class="anchored" data-anchor-id="getting-administrative-units-new-state">Getting administrative units new state</h4>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> State(measurements_t0, gdf_grid, cbs<span class="op">=</span>[</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    MaxCB(), MinCB(), StdCB(), CountCB(), MoranICB(k<span class="op">=</span><span class="dv">5</span>), PriorCB(fname_raster)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>state().head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Max</th>
<th data-quarto-table-cell-role="th">Min</th>
<th data-quarto-table-cell-role="th">Standard Deviation</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Moran.I</th>
<th data-quarto-table-cell-role="th">Prior</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loc_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.137188</td>
<td>0.137188</td>
<td>0.0</td>
<td>1</td>
<td>NaN</td>
<td>0.102492</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.151005</td>
<td>0.151005</td>
<td>0.0</td>
<td>1</td>
<td>NaN</td>
<td>0.125727</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.164272</td>
<td>0.164272</td>
<td>0.0</td>
<td>1</td>
<td>NaN</td>
<td>0.161802</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.181001</td>
<td>0.181001</td>
<td>0.0</td>
<td>1</td>
<td>NaN</td>
<td>0.184432</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.168969</td>
<td>0.168969</td>
<td>0.0</td>
<td>1</td>
<td>NaN</td>
<td>0.201405</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>Moran’s I index</strong> is a statistical method used to determine if there is a <strong>spatial correlation/trend</strong> within each area of interest. For example, a <strong>random field</strong> would have a <strong>Moran’s I index close to 0</strong>, while a clear <strong>gradient of low to high values</strong>, such as from south to north, would be characterized by a <strong>Moran’s I index close to 1</strong>.</p>
</div>
</div>
</section>
<section id="finding-optimal-number-of-samples-to-be-collected" class="level4">
<h4 class="anchored" data-anchor-id="finding-optimal-number-of-samples-to-be-collected">Finding optimal number of samples to be collected</h4>
<ol type="1">
<li>We first decide if each variable of the State are to maximize (<strong>benefit</strong>) or minimize (<strong>cost</strong>):</li>
</ol>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>benefit_criteria <span class="op">=</span> [<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>, <span class="va">False</span>, <span class="va">False</span>, <span class="va">True</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Then assign an <strong>importance weight</strong> to each of the variable of the <a href="https://franckalbinet.github.io/trufl/callbacks.html#state"><code>State</code></a> (<code>Min</code>, <code>Max</code>, …):</li>
</ol>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> Optimizer(state<span class="op">=</span>state())</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_rank <span class="op">=</span> optimizer.get_rank(is_benefit_x<span class="op">=</span>benefit_criteria, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                             w_vector <span class="op">=</span> [<span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>],  </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                             n_method<span class="op">=</span><span class="st">"LINEAR1"</span>, c_method<span class="op">=</span><span class="va">None</span>, w_method<span class="op">=</span><span class="va">None</span>, s_method<span class="op">=</span><span class="st">"CP"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>gdf_grid.join(df_rank, how<span class="op">=</span><span class="st">'left'</span>).plot(column<span class="op">=</span><span class="st">'rank'</span>,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                                        cmap<span class="op">=</span><span class="st">'viridis_r'</span>, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                                        legend_kwds<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Rank'</span>}, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                        legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Sampling Priorirty Rank'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_rank.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loc_id</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">73</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">27</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">78</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Based on this rank we can again: 1. based on the <strong>ranks (sampling priority)</strong> and given sampling <strong>budget</strong>, calculate the number of samples to be collected for each administrative unit and carry out <strong>random sampling</strong>; 2. <strong>perform</strong> the random <strong>sampling</strong>; 3. and <strong>carry out</strong> the <strong>measurements</strong>.</p>
</section>
<section id="informed-random-sampling-1" class="level4">
<h4 class="anchored" data-anchor-id="informed-random-sampling-1">Informed random sampling</h4>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>budget_t1 <span class="op">=</span> <span class="dv">400</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> rank_to_sample(df_rank[<span class="st">'rank'</span>].sort_index().values, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                   budget<span class="op">=</span>budget_t1, <span class="bu">min</span><span class="op">=</span><span class="dv">1</span>, policy<span class="op">=</span><span class="st">"quantiles"</span>)<span class="op">;</span> n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([1, 1, 1, 1, 1, 1, 3, 4, 3, 1, 1, 1, 1, 1, 1, 1, 3, 1, 3, 8, 1, 1,
       1, 1, 8, 8, 8, 8, 4, 8, 1, 1, 1, 3, 8, 4, 4, 4, 8, 3, 1, 1, 3, 4,
       4, 4, 4, 4, 4, 3, 1, 3, 4, 4, 8, 3, 3, 4, 8, 8, 1, 8, 3, 3, 4, 4,
       4, 3, 4, 8, 8, 8, 8, 8, 4, 3, 4, 8, 8, 8, 8, 4, 8, 8, 4, 3, 3, 3,
       3, 3, 8, 4, 3, 3, 4, 4, 3, 8, 3, 3])</code></pre>
</div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> Sampler(gdf_grid)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>sample_locs_t1 <span class="op">=</span> sampler.sample(n, method<span class="op">=</span><span class="st">'uniform'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sample_locs_t1.plot(markersize<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span>red)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>gdf_grid.boundary.plot(color<span class="op">=</span>black, lw<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Ranked Random Samples Location'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="second-measurement-campaign" class="level4">
<h4 class="anchored" data-anchor-id="second-measurement-campaign">Second measurement campaign</h4>
<div id="cell-61" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dc_emulator <span class="op">=</span> DataCollector(fname_raster)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>measurements_t1 <span class="op">=</span> dc_emulator.collect(sample_locs_t1)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> measurements_t1.plot(column<span class="op">=</span><span class="st">'value'</span>, s<span class="op">=</span><span class="dv">2</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>gdf_grid.boundary.plot(color<span class="op">=</span>black, lw<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Measurements at Random Sampling Points'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>measurements_sofar <span class="op">=</span> pd.concat([measurements_t0, measurements_t1])</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> measurements_sofar.plot(column<span class="op">=</span><span class="st">'value'</span>, s<span class="op">=</span><span class="dv">2</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>gdf_grid.boundary.plot(color<span class="op">=</span>black, lw<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'off'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Measurements after </span><span class="ch">\n</span><span class="st"> 2 informed measurement campaigns'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="delving-deeper-into-the-optimization-process" class="level2">
<h2 class="anchored" data-anchor-id="delving-deeper-into-the-optimization-process">Delving deeper into the optimization process</h2>
<section id="determine-the-ranking-of-the-administrative-polygons" class="level3">
<h3 class="anchored" data-anchor-id="determine-the-ranking-of-the-administrative-polygons">Determine the ranking of the administrative polygons</h3>
<p>The <strong>ranking</strong> is based on the importance of increasing sampling in each polygon. A multi-criteria decision-making methodology is used to rank the polygons from most important to least important, with <strong>lower ranks indicating a higher priority for sampling</strong>.</p>
<section id="criteria" class="level4">
<h4 class="anchored" data-anchor-id="criteria">Criteria</h4>
<p>The state of the polygons will be used as criteria to determine the rank:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Criteria</th>
<th>State variable</th>
<th>Criteria Type</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Estimated value</td>
<td>PriorCB()</td>
<td>Benefit</td>
<td></td>
</tr>
<tr class="even">
<td>Maximum sample value</td>
<td>MaxCB()</td>
<td>Benefit</td>
<td></td>
</tr>
<tr class="odd">
<td>Minimal sample value</td>
<td>MinCB()</td>
<td>Benefit</td>
<td></td>
</tr>
<tr class="even">
<td>Sample count</td>
<td>CountCB()</td>
<td>Cost</td>
<td></td>
</tr>
<tr class="odd">
<td>Standard deviation</td>
<td>StdCB()</td>
<td>Benefit</td>
<td></td>
</tr>
<tr class="even">
<td>Moran I index</td>
<td>MoranICB(k=5)</td>
<td>Cost</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="criteria-type" class="level4">
<h4 class="anchored" data-anchor-id="criteria-type">Criteria type</h4>
<p>Criteria can be of the type benefit or cost:</p>
<ul>
<li>Benefit: <strong>high values</strong> equal <strong>high importance</strong> to sample more;</li>
<li>Cost: <strong>low value</strong> equal <strong>high importance</strong> to sample more).</li>
</ul>
</section>
<section id="weights" class="level4">
<h4 class="anchored" data-anchor-id="weights">Weights</h4>
<p>A <strong>weight vector</strong> is used to determine the <strong>importance of criteria</strong> in comparison with each other.</p>
</section>
<section id="mcdm-techniques" class="level4">
<h4 class="anchored" data-anchor-id="mcdm-techniques">MCDM techniques</h4>
<ul>
<li><strong>CP</strong> (Compromise programming):
<ul>
<li>Distance based measure, where the distance to the optmal point is used, where low values relate to good alternatives.</li>
</ul></li>
<li><strong>TOPSIS</strong> (Technique for Order Preference by Similarity to Ideal Solution):
<ul>
<li>Distance-based measure, where the closeness to the optimal and anti-optimal points is assessed (with higher values indicating better alternatives).</li>
</ul></li>
</ul>
</section>
<section id="rank" class="level4">
<h4 class="anchored" data-anchor-id="rank">Rank</h4>
<p>Based on the MCDM value a ranking of the polygons is created:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Start with using equal weights for all the criteria, later you will explore the impact of changing the weight vector. Make sure the sum of the weight vector is 1.</p>
</div>
</div>
<p>Ranking of administrative units based on three criteria:</p>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>benefit_criteria <span class="op">=</span> [<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> State(measurements_sofar, gdf_grid, cbs<span class="op">=</span>[MaxCB(), MinCB(), StdCB()])</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>weight_vector <span class="op">=</span> [<span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> Optimizer(state<span class="op">=</span>state())</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> optimizer.get_rank(is_benefit_x<span class="op">=</span>benefit_criteria, w_vector <span class="op">=</span> weight_vector,  </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                    n_method<span class="op">=</span><span class="st">"LINEAR1"</span>, c_method <span class="op">=</span> <span class="va">None</span>, w_method<span class="op">=</span><span class="va">None</span>, s_method<span class="op">=</span><span class="st">"CP"</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loc_id</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">71</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">72</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">69</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Based on the ranking of the administrative units, an optimized sampling strategy for <span class="math inline">\(t_1\)</span> can be determined.</p>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> pd.merge(df, gdf_grid[[<span class="st">'geometry'</span>]], left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>combined_gdf <span class="op">=</span> gpd.GeoDataFrame(combined_df)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>cax <span class="op">=</span> combined_gdf.plot(column<span class="op">=</span><span class="st">'rank'</span>, cmap<span class="op">=</span><span class="st">'Reds_r'</span>, legend<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>measurements_sofar.plot(column<span class="op">=</span><span class="st">'value'</span>, ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'viridis'</span>, s<span class="op">=</span><span class="fl">1.5</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> cax.get_figure().get_axes()[<span class="dv">1</span>]</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>cbar.invert_yaxis()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>rank_legend <span class="op">=</span> mlines.Line2D([], [], color<span class="op">=</span><span class="st">'Red'</span>, marker<span class="op">=</span><span class="st">'o'</span>, linestyle<span class="op">=</span><span class="st">'None'</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>                            markersize<span class="op">=</span><span class="dv">10</span>, label<span class="op">=</span><span class="st">'High Rank'</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>value_legend <span class="op">=</span> mlines.Line2D([], [], color<span class="op">=</span><span class="st">'Yellow'</span>, marker<span class="op">=</span><span class="st">'o'</span>, linestyle<span class="op">=</span><span class="st">'None'</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>                             markersize<span class="op">=</span><span class="dv">10</span>, label<span class="op">=</span><span class="st">'High prior value'</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>ax.legend(handles<span class="op">=</span>[rank_legend, value_legend], loc<span class="op">=</span><span class="st">'upper left'</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.5</span>, <span class="fl">1.25</span>))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="multi-year-adaptive-sampling-approach" class="level3">
<h3 class="anchored" data-anchor-id="multi-year-adaptive-sampling-approach">Multi-year Adaptive sampling approach</h3>
<ul>
<li>Sampling in year 0 will done based on the prior;</li>
<li>Sampling in year t will be done based on 6 state variables:
<ul>
<li>[Max value, Min value, Standard deviation, sample count, Moran I, Prior value]</li>
<li>[0.2, 0.1, 0.1, 0.2, 0.2, 0.2]</li>
</ul></li>
<li>Sampling policy will be based on the point budget and the quantile in which the unit ranks:
<ul>
<li>1st: 50 % of point budget</li>
<li>2nd: 30% of point budget</li>
<li>3th: 20% of point budget</li>
<li>4th: no extra sample points</li>
</ul></li>
</ul>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>number_of_years <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>yearly_sample_budget <span class="op">=</span> <span class="dv">150</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, number_of_years, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))  <span class="co"># Adjust figsize as needed</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>axs <span class="op">=</span> axs.flatten()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> Sampler(gdf_grid)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>dc_emulator <span class="op">=</span> DataCollector(fname_raster)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Samples</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>samples_t_0 <span class="op">=</span> gpd.GeoDataFrame(index<span class="op">=</span>pd.Index([], name<span class="op">=</span><span class="st">'loc_id'</span>), geometry<span class="op">=</span><span class="va">None</span>, data<span class="op">=</span>{<span class="st">'value'</span>: <span class="va">None</span>})</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>samples_t <span class="op">=</span> []</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> State(samples_t_0, gdf_grid, cbs<span class="op">=</span>[PriorCB(fname_raster)])</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># You have to call the instance</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>state_t0 <span class="op">=</span> state()</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>benefit_criteria <span class="op">=</span> [<span class="va">True</span>]</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> Optimizer(state<span class="op">=</span>state_t0)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>df_rank <span class="op">=</span> optimizer.get_rank(is_benefit_x<span class="op">=</span>benefit_criteria, w_vector <span class="op">=</span> [<span class="dv">1</span>],  </span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>                             n_method<span class="op">=</span><span class="va">None</span>, c_method <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>                             w_method<span class="op">=</span><span class="va">None</span>, s_method<span class="op">=</span><span class="st">"CP"</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> pd.merge(df, gdf_grid[[<span class="st">'geometry'</span>]], left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>combined_gdf <span class="op">=</span> gpd.GeoDataFrame(combined_df)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>combined_gdf.plot(column<span class="op">=</span><span class="st">'rank'</span>,cmap<span class="op">=</span><span class="st">'Reds_r'</span>, legend_kwds<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Rank'</span>}, ax <span class="op">=</span> axs[<span class="dv">0</span>])</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fig_n, ax <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">range</span>(<span class="dv">1</span>, number_of_years<span class="op">+</span><span class="dv">1</span>), axs[<span class="dv">1</span>:]):</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> rank_to_sample(combined_gdf[<span class="st">'rank'</span>].sort_index().values, </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>                    budget<span class="op">=</span>yearly_sample_budget, <span class="bu">min</span><span class="op">=</span><span class="dv">1</span>, policy<span class="op">=</span><span class="st">"quantiles"</span>)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    sample_locs_t <span class="op">=</span> sampler.sample(n, method<span class="op">=</span><span class="st">'uniform'</span>)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    samples <span class="op">=</span> dc_emulator.collect(sample_locs_t)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        samples_t <span class="op">=</span> pd.concat([samples_t, samples])</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        samples_t <span class="op">=</span> pd.concat([samples])</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot points versus rank of polygon</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> combined_gdf.plot(column<span class="op">=</span><span class="st">'rank'</span>, cmap<span class="op">=</span><span class="st">'Reds_r'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    samples_t.plot(column<span class="op">=</span><span class="st">'value'</span>, ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'viridis'</span>, s<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    ax.title.set_text(<span class="ss">f"Year </span><span class="sc">{</span>fig_n<span class="sc">}</span><span class="ss"> (number of samples: </span><span class="sc">{</span><span class="bu">len</span>(samples_t)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new state</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> State(samples_t, gdf_grid, cbs<span class="op">=</span>[</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>        MaxCB(), MinCB(), StdCB(), CountCB(), MoranICB(k<span class="op">=</span><span class="dv">5</span>), PriorCB(fname_raster)])</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> Optimizer(state<span class="op">=</span>state())</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. rank polygons</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    benefit_criteria <span class="op">=</span> [<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>, <span class="va">False</span>, <span class="va">False</span>, <span class="va">True</span>]</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> optimizer.get_rank(is_benefit_x<span class="op">=</span>benefit_criteria, w_vector <span class="op">=</span> [<span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>],  n_method<span class="op">=</span><span class="st">"LINEAR1"</span>, c_method <span class="op">=</span> <span class="va">None</span>, w_method<span class="op">=</span><span class="va">None</span>, s_method<span class="op">=</span><span class="st">"CP"</span>)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. map ranking</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    combined_df <span class="op">=</span> pd.merge(df, gdf_grid[[<span class="st">'geometry'</span>]], left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    combined_gdf <span class="op">=</span> gpd.GeoDataFrame(combined_df)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/franckalbinet\.github\.io\/trufl");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/franckalbinet/trufl/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>